<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Monaco Editor in WebView2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.30.1/min/vs/loader.js"></script>
    <style>
        html,
        body,
        #editor {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <div id="editor"></div>
    <script>
        document.addEventListener('keydown', function (event) {
            if (event.key === 'F5') {
                event.preventDefault();
            }
        });

        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.30.1/min/vs' } });
        require(['vs/editor/editor.main'], function () {
            monaco.languages.register({
                id: 'sql',
                extensions: ['.sql'],
                aliases: ['SQL', 'sql'],
                mimetypes: ['text/sql']
            });

            monaco.editor.defineTheme('DarkTheme', {
                base: 'vs-dark',
                inherit: true,
                rules: [
                    { token: 'comment.sql', foreground: '888888' },
                    { token: 'comment.quote.sql', foreground: '888888' },
                    { token: 'keyword.sql', foreground: '569cd6', fontStyle: 'bold' },
                    { token: 'number.sql', foreground: 'b5cea8' },
                    { token: 'string.sql', foreground: 'ef6e15' },
                    { token: 'predefined.sql', foreground: 'efe528', fontStyle: 'bold' },
                    { token: 'delimiter.sql', foreground: 'cc96f8' },
                    { token: 'delimiter.parenthesis.sql', foreground: '8899aa', fontStyle: 'bold' },
                    { token: 'operator.sql', foreground: 'cc96f8' },
                    //{ token: 'predefined.sql', foreground: '0fec50', fontStyle: 'bold' },
                ],
                colors: {
                    'editor.background': '#1e1e1e',
                    'editor.foreground': '#efefef',
                }
            });

            var editor = monaco.editor.create(document.getElementById('editor'), {
                value: "",
                language: "sql",
                theme: "DarkTheme",
                fontSize: 13.5,
                fontFamily: 'Consolas, 맑은 고딕, monospace',
                letterSpacing: -0.6,
                wordWrap: "on",
                // IntelliSense 설정 강화
                quickSuggestions: true,
                suggestOnTriggerCharacters: true,
                acceptSuggestionOnEnter: "on",
                tabCompletion: "on",
                suggestSelection: "first",
                wordBasedSuggestions: true,
                parameterHints: { enabled: true },
                autoClosingBrackets: "always",
                autoClosingQuotes: "always",
                formatOnType: true,
                formatOnPaste: true
            });

            window.onresize = () => {
                const editorContainer = document.getElementById('editor');
                const width = window.innerWidth;   // 현재 윈도우 가로 크기
                const height = window.innerHeight; // 현재 윈도우 세로 크기

                // WebView2 내부 요소 크기 조정
                editorContainer.style.width = `${width}px`;
                editorContainer.style.height = `${height}px`;

                // Monaco Editor 레이아웃 업데이트
                editor.layout();
            };

            window.setEditorText = function (text) {
                // 줄 바꿈 문자 정규화: JavaScript에서도 일관되게 처리
                text = text.replace(/\\n/g, '\n').replace(/\r\n/g, '\n').replace(/\r/g, '\n');
                editor.setValue(text);
            };

            window.getEditorText = function () {
                return editor.getValue();
            };

            window.appendEditorText = function (text) {
                // 줄 바꿈 문자 정규화: JavaScript에서도 일관되게 처리
                text = text.replace(/\\n/g, '\n').replace(/\r\n/g, '\n').replace(/\r/g, '\n');
                var currentText = editor.getValue();
                var newText = currentText + text;
                editor.setValue(newText);
            };

            window.getSelectedText = function () {
                var selection = editor.getSelection();
                var model = editor.getModel();
                var selectedText = model.getValueInRange(selection);
                return selectedText;
            };

            // 자동완성 {
            let autocompleteItems = [];
            let tableColumns = {}; // 테이블별 컬럼 정보 캐싱

            window.setAutocompleteData = function (jsonData) {
                try {
                    autocompleteItems = JSON.parse(jsonData);
                } catch (e) {
                    console.error('Error parsing autocomplete data:', e);
                    autocompleteItems = [];
                }
            };

            // 테이블 컬럼 정보 설정
            window.setTableColumns = function (tableName, columns) {
                try {
                    tableColumns[tableName] = columns;
                    console.log(`Table columns loaded for ${tableName}:`, columns);
                } catch (e) {
                    console.error('Error setting table columns:', e);
                }
            };

            // 현재 라인의 FROM 절에서 테이블명 추출
            function extractTableFromFromClause(line, position) {
                // 라인 전체에서 FROM 절의 테이블명 추출
                const fromRegex = /\bFROM\s+([a-zA-Z_][a-zA-Z0-9_]*)/gi;
                const matches = [...line.matchAll(fromRegex)];

                if (matches.length > 0) {
                    // 커서 위치와 가장 가까운 FROM 절의 테이블명을 찾음
                    let closestMatch = null;
                    let closestDistance = Infinity;

                    for (const match of matches) {
                        const matchEnd = match.index + match[0].length;
                        const distance = Math.abs(position.column - matchEnd);

                        if (distance < closestDistance) {
                            closestDistance = distance;
                            closestMatch = match;
                        }
                    }

                    if (closestMatch) {
                        return closestMatch[1];
                    }
                }
                return null;
            }

            // 전체 쿼리에서 FROM 절 테이블명 추출 (여러 라인 지원)
            function extractTableFromFullQuery(model, position) {
                const currentLine = model.getLineContent(position.lineNumber);
                const lineCount = model.getLineCount();

                // 현재 라인과 이전 라인들을 검사하여 FROM 절 찾기
                for (let lineNum = position.lineNumber; lineNum >= 1; lineNum--) {
                    const line = model.getLineContent(lineNum);
                    const tableName = extractTableFromFromClause(line, position);

                    if (tableName) {
                        return tableName;
                    }

                    // SELECT 문이 시작되면 검색 중단
                    if (line.trim().toUpperCase().startsWith('SELECT') && lineNum < position.lineNumber) {
                        break;
                    }
                }

                return null;
            }

            // 테이블 컬럼 자동완성 항목 생성
            function createTableColumnCompletions(tableName) {
                const columns = tableColumns[tableName];
                if (!columns) return [];

                return columns.map(column => ({
                    label: column,
                    kind: monaco.languages.CompletionItemKind.Field,
                    insertText: column,
                    detail: `Column of ${tableName}`,
                    documentation: `Column from table ${tableName}`
                }));
            }

            // SQL 키워드 기본 자동완성 항목
            const sqlKeywords = [
                { label: 'SELECT', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'SELECT' },
                { label: 'FROM', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'FROM' },
                { label: 'WHERE', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'WHERE' },
                { label: 'INSERT', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'INSERT' },
                { label: 'INTO', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'INTO' },
                { label: 'VALUES', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'VALUES' },
                { label: 'UPDATE', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'UPDATE' },
                { label: 'SET', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'SET' },
                { label: 'DELETE', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'DELETE' },
                { label: 'CREATE', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'CREATE' },
                { label: 'TABLE', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'TABLE' },
                { label: 'ALTER', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'ALTER' },
                { label: 'DROP', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'DROP' },
                { label: 'INDEX', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'INDEX' },
                { label: 'JOIN', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'JOIN' },
                { label: 'INNER', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'INNER' },
                { label: 'LEFT', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'LEFT' },
                { label: 'RIGHT', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'RIGHT' },
                { label: 'OUTER', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'OUTER' },
                { label: 'ON', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'ON' },
                { label: 'AND', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'AND' },
                { label: 'OR', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'OR' },
                { label: 'NOT', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'NOT' },
                { label: 'IN', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'IN' },
                { label: 'EXISTS', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'EXISTS' },
                { label: 'LIKE', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'LIKE' },
                { label: 'BETWEEN', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'BETWEEN' },
                { label: 'IS', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'IS' },
                { label: 'NULL', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'NULL' },
                { label: 'ORDER', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'ORDER' },
                { label: 'BY', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'BY' },
                { label: 'GROUP', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'GROUP' },
                { label: 'HAVING', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'HAVING' },
                { label: 'UNION', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'UNION' },
                { label: 'ALL', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'ALL' },
                { label: 'DISTINCT', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'DISTINCT' },
                { label: 'TOP', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'TOP' },
                { label: 'ASC', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'ASC' },
                { label: 'DESC', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'DESC' },
                { label: 'CASE', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'CASE' },
                { label: 'WHEN', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'WHEN' },
                { label: 'THEN', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'THEN' },
                { label: 'ELSE', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'ELSE' },
                { label: 'END', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'END' }
            ];

            const snippetItems = [
                {
                    label: 'SELECT * FROM...',
                    kind: monaco.languages.CompletionItemKind.Snippet,
                    insertText: 'SELECT * FROM ${1:table_name} WHERE ${2:condition};',
                    insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                    documentation: 'SELECT 전체 쿼리 자동완성'
                },
                {
                    label: 'INSERT INTO...',
                    kind: monaco.languages.CompletionItemKind.Snippet,
                    insertText: 'INSERT INTO ${1:table_name} (${2:column1, column2})\\nVALUES (${3:value1, value2});',
                    insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                    documentation: 'INSERT 문 자동완성'
                },
                {
                    label: 'UPDATE SET...',
                    kind: monaco.languages.CompletionItemKind.Snippet,
                    insertText: 'UPDATE ${1:table_name}\\nSET ${2:column} = ${3:value}\\nWHERE ${4:condition};',
                    insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                    documentation: 'UPDATE 문 자동완성'
                },
                {
                    label: 'DELETE FROM...',
                    kind: monaco.languages.CompletionItemKind.Snippet,
                    insertText: 'DELETE FROM ${1:table_name}\\nWHERE ${2:condition};',
                    insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                    documentation: 'DELETE 문 자동완성'
                },
                {
                    label: 'CREATE TABLE...',
                    kind: monaco.languages.CompletionItemKind.Snippet,
                    insertText: 'CREATE TABLE ${1:table_name} (\\n    ${2:id} INT PRIMARY KEY,\\n    ${3:name} VARCHAR(100)\\n);',
                    insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                    documentation: 'CREATE TABLE 문 자동완성'
                },
                {
                    label: 'IF...BEGIN...END',
                    kind: monaco.languages.CompletionItemKind.Snippet,
                    insertText: 'IF ${1:condition}\\nBEGIN\\n    ${2:statement}\\nEND',
                    insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                    documentation: 'IF 문 자동완성'
                },
                {
                    label: 'IF...ELSE...BEGIN...END',
                    kind: monaco.languages.CompletionItemKind.Snippet,
                    insertText: 'IF ${1:condition}\\nBEGIN\\n    ${2:statement}\\nEND\\nELSE\\nBEGIN\\n    ${3:else_statement}\\nEND',
                    insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                    documentation: 'IF ELSE 문 자동완성'
                }
            ];

            // 향상된 자동완성 공급자
            monaco.languages.registerCompletionItemProvider('sql', {
                provideCompletionItems: function (model, position) {
                    var suggestions = [];

                    // 현재 커서 위치의 단어 가져오기
                    var word = model.getWordUntilPosition(position);

                    // 현재 라인 텍스트 가져오기
                    var currentLine = model.getLineContent(position.lineNumber);

                    // 기본 SQL 키워드 추가
                    suggestions.push(...sqlKeywords);

                    // 스니펫 추가
                    suggestions.push(...snippetItems);

                    // FROM 절에서 테이블명 추출 및 해당 테이블 컬럼 추가
                    var tableName = extractTableFromFullQuery(model, position);
                    if (tableName) {
                        var tableColumnSuggestions = createTableColumnCompletions(tableName);
                        suggestions.push(...tableColumnSuggestions);

                        // 테이블 컬럼이 없으면 데이터 로드 시도
                        if (tableColumnSuggestions.length === 0) {
                            console.log(`No columns cached for table ${tableName}, attempting to load...`);
                            // C#으로부터 테이블 컬럼 데이터 요청
                            if (window.external && window.external.loadTableColumns) {
                                window.external.loadTableColumns(tableName);
                            }
                        }
                    }

                    // 동적 자동완성 항목 추가
                    if (autocompleteItems && autocompleteItems.length > 0) {
                        var dynamicSuggestions = autocompleteItems.map(item => ({
                            label: item.text || item.label,
                            kind: monaco.languages.CompletionItemKind.Variable,
                            insertText: item.text || item.label,
                            detail: item.detail || '',
                            documentation: item.documentation || item.text || item.label
                        }));
                        suggestions.push(...dynamicSuggestions);
                    }

                    return { suggestions: suggestions };
                },
                triggerCharacters: [' ', '.', '(', '"', "'", '[', ','] // 자동완성 트리거 문자
            });
            // } 자동완성

        });
    </script>
</body>

</html>